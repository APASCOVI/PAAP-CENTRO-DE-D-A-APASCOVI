<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PAAP CENTRO DE D√çA APASCOVI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="img/icono.png">
  
  <!-- Librer√≠as PDF / Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>

  <!-- Ajustes puntuales (firmas en l√≠nea + desplegable PDF) -->
  <style>
    /* --- Firmas: 3 bloques en l√≠nea (inicial m√°s grande) --- */
    .firmas-paap{
      display:grid !important;
      grid-template-columns: 2.2fr 1fr 1fr;
      gap:16px;
      align-items:start;
      width:100%;
    }
    /* Para que los dos bloques de revisi√≥n act√∫en como columnas 2 y 3 sin cambiar el HTML */
    .firmas-paap .firmas-revisiones{
      display:contents;
    }
    .firmas-paap .firma-bloque{
      width:100%;
    }
    .firmas-paap .firma-canvas{
      width:100%;
      height:190px;
      display:block;
    }
    .firmas-paap .firma-inicial .firma-canvas{
      height:230px;
    }

    @media (max-width: 980px){
      .firmas-paap{
        grid-template-columns: 1fr;
      }
    }

    /* --- Desplegable PDF --- */
    .export-dropdown{
      position:relative;
      display:inline-block;
    }
    .pdf-menu{
      position:absolute;
      right:0;
      bottom: calc(100% + 8px);
      min-width: 280px;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.14);
      padding: 6px;
      z-index: 9999;
    }
    .pdf-menu .pdf-menu-item{
      width:100%;
      text-align:left;
      padding: 10px 12px;
      border-radius: 12px;
      border:none;
      background:transparent;
      cursor:pointer;
      font-size: 14px;
      color:#111;
    }
    .pdf-menu .pdf-menu-item:hover{
      background:#f3f4f6;
    }
  </style>

</head>

<body>

<div class="app-root">

  <!-- ==========================================================
       ENCABEZAMIENTO NUEVO (LOGO CENTRAL + 3 LOGOS PEQUE√ëOS)
  ============================================================ -->
  <header class="header-paap">
      <div class="header-logos-container">

          <!-- Logo APASCOVI grande en el centro -->
          <div class="logo-apascovi-wrapper">
            <img src="img/logo_APASCOVI.png" class="logo-apascovi-grande">
          </div>

      </div>

      <h1 class="titulo-app">PAAP ‚Äì Plan de Apoyo y Atenci√≥n Personalizada</h1>
      <h2 class="subtitulo-app">CENTRO DE D√çA APASCOVI ¬∑ Fundaci√≥n APASCOVI</h2>
  </header>



  <!-- ==========================================================
         DATOS DE LA PERSONA USUARIA
  ============================================================ -->
  <section class="card datos-persona-section">
      <h2 class="section-title">Datos de la persona usuaria</h2>

      <div class="datos-persona-grid">

          <!-- COLUMNA IZQUIERDA -->
          <div class="datos-izq">

              <div class="field-group">
                  <label>Nombre</label>
                  <input type="text" id="nombre">
              </div>

              <div class="field-group">
                  <label>Apellidos</label>
                  <input type="text" id="apellidos">
              </div>

              <div class="field-group">
                  <label>Fecha de nacimiento</label>
                  <input type="date" id="fecha_nacimiento">
              </div>

              <div class="field-group">
                  <label>Edad</label>
                  <input type="text" id="edad" readonly class="readonly-field">
              </div>

              <div class="field-group">
                  <label>A√±os como persona usuaria del CENTRO DE D√çA APASCOVI</label>
                  <select id="anios_cofoil">
                      <option value="">Selecciona...</option>
                  </select>
              </div>

              <div class="field-group hidden">
                  <label>Taller ocupacional actual</label>
                  <select id="taller">
                      <option value="">Selecciona...</option>
                      <option value="Taller Formativo Lavander√≠a 1">Taller Formativo Lavander√≠a 1</option>
                      <option value="Taller Formativo Lavander√≠a 2">Taller Formativo Lavander√≠a 2</option>
                      <option value="Taller Formativo Artesan√≠a">Taller Formativo Artesan√≠a</option>
                      <option value="Taller Formativo Manipulados">Taller Formativo Manipulados</option>
                  </select>
              </div>

              <div class="field-group hidden">
                  <label>Perfil Ocupacional</label>
                  <select id="perfil_ocupacional_si_no">
                      <option value="">Selecciona‚Ä¶</option>
                      <option value="NO">NO</option>
                      <option value="SI">SI</option>
                  </select>
              </div>

              <div id="bloque-perfiles" class="hidden">

                  <div class="field-group">
                      <label>Selecciona perfil ocupacional</label>
                      <select id="perfil_ocupacional_selector">
                          <option value="">Selecciona‚Ä¶</option>
                          <option>Perfil Ocupacional de Office</option>
                          <option>Perfil Ocupacional de Jardiner√≠a</option>
                          <option>Perfil Ocupacional de Mantenimiento</option>
                          <option>Perfil Ocupacional de Camarera de Pisos</option>
                          <option>Perfil Ocupacional de Limpieza de Superficies y Mobiliario</option>
                          <option>Perfil Ocupacional de Servicios Administrativos Generales</option>
                          <option>Perfil Ocupacional de Servicios de Proximidad</option>
                          <option>Perfil Ocupacional de Cafeter√≠a y Bar</option>
                      </select>
                  </div>

                  <div class="add-perfiles-dinamicos">
                      <label>A√±adir nuevo perfil</label>
                      <input type="text" id="nuevo_perfil">
                      <button class="btn-add-perfil">‚ûï A√±adir perfil</button>
                  </div>
              </div>
          </div>



          <!-- COLUMNA DERECHA ¬∑ FOTO -->
          <div class="datos-der">
              <h3>Fotograf√≠a</h3>

              <div class="foto-dni-wrapper">
                  <img id="foto-preview" class="foto-dni" alt="Foto de la persona">
              </div>

              <div class="foto-buttons">
                  <label class="btn-foto azul">
                      üìÅ Subir imagen
                      <input type="file" id="foto-file" hidden accept="image/*">
                  </label>

                  <button id="abrir-camara" class="btn-foto verde">üì∑ Usar c√°mara</button>
              </div>

              <div id="modal-camara" class="modal-camara hidden">
                  <div class="modal-camara-contenido card">
                      <h3>Tomar fotograf√≠a</h3>
                      <video id="camara-video" autoplay playsinline></video>

                      <div class="camera-actions">
                          <button id="tomar-foto" class="btn primary">üì∏ Tomar foto</button>
                          <button id="cerrar-camara" class="btn ghost">Cerrar</button>
                      </div>

                      <canvas id="camara-canvas" class="hidden"></canvas>
                  </div>
              </div>
          </div>

      </div>
  </section>
  <!-- ==========================================================
       DATOS DE ELABORACI√ìN DEL PAAP
  ============================================================ -->
  <section class="card datos-elaboracion-section">
      <h2 class="section-title">Datos de elaboraci√≥n del PAAP</h2>

      <div class="datos-elaboracion-grid">

          <div class="field-group">
              <label>Fecha</label>
              <input type="date" id="paap_fecha">
          </div>

          <div class="field-group">
              <label>Hora</label>
              <input type="time" id="paap_hora">
          </div>

          <div class="field-group">
              <label>Persona/s de apoyo en la elaboraci√≥n</label>
              <div id="apoyos-container"></div>
              <button id="add-apoyo" class="btn secondary small">‚ûï A√±adir persona</button>
          </div>

          <div class="field-group">
              <label>Periodo de vigencia / revisi√≥n del PAAP</label>
              <select id="paap_vigencia">
                  <option value="">Selecciona‚Ä¶</option>
                  <option value="3">3 meses</option>
                  <option value="6">6 meses</option>
                  <option value="9">9 meses</option>
                  <option value="12">12 meses</option>
              </select>
          </div>

          <div class="field-group">
              <label>Pr√≥xima revisi√≥n</label>
              <input type="text" id="paap_proxima_revision" readonly class="readonly-field">
          </div>
      </div>
  </section>



  <!-- ==========================================================
         DISE√ëO DEL PAAP
  ============================================================ -->
  <section class="card diseno-paap-section">
      <h2 class="section-title">DISE√ëO DEL PAAP</h2>

      <div class="tabs-header" id="areas-tabs"></div>
      <div class="tabs-body" id="area-content"></div>
  </section>

  <!-- ==========================================================
         RESUMEN DEL PAAP
  ============================================================ -->
  <section id="resumen-section" class="card resumen-paap-section">
      <h2 id="titulo-resumen" class="titulo-resumen">
          PAAP PARA [Nombre de la persona] ‚Äì desde [mes/a√±o] hasta [mes/a√±o]
      </h2>

      <div class="resumen-datos-globales">

          <div class="resumen-bloque resumen-persona-info">
              <h3>Datos de la persona usuaria</h3>
              <div class="resumen-persona-lineas" id="resumen-persona-texto"></div>
          </div>

          <div class="resumen-bloque resumen-elaboracion-info">
              <h3>Datos de elaboraci√≥n del PAAP</h3>
              <div class="resumen-elaboracion-lineas" id="resumen-elaboracion-texto"></div>
          </div>

          <div class="resumen-bloque resumen-foto-bloque">
              <h3>Fotograf√≠a</h3>
              <div class="resumen-foto-dni-wrapper">
                  <img id="resumen-foto" class="foto-dni-resumen" alt="Foto PAAP">
              </div>
          </div>
      </div>

      <!-- Bloques por √°rea -->
      <div id="resumen-areas" class="resumen-areas-contenedor"></div>

      <!-- Bloques de firmas -->
      <div class="firmas-paap">
        <div class="firma-bloque firma-inicial">
          <h3>Firma elaboraci√≥n inicial del PAAP</h3>
          <canvas id="firma-inicial" class="firma-canvas"></canvas>
          <button type="button" id="clear-firma-inicial" class="btn ghost small">Borrar firma</button>
        </div>

        <div class="firmas-revisiones">
          <div class="firma-bloque">
            <h3>Firma revisi√≥n 1</h3>
            <canvas id="firma-rev1" class="firma-canvas"></canvas>
            <button type="button" id="clear-firma-rev1" class="btn ghost small">Borrar firma</button>
          </div>
          <div class="firma-bloque">
            <h3>Firma revisi√≥n 2</h3>
            <canvas id="firma-rev2" class="firma-canvas"></canvas>
            <button type="button" id="clear-firma-rev2" class="btn ghost small">Borrar firma</button>
          </div>
        </div>
      </div>

      <!-- Botones de exportaci√≥n -->
      <div class="resumen-export-buttons">
          <div class="export-dropdown">
              <button id="btn-pdf" class="btn-export rojo">üìÑ Descargar PDF ‚ñæ</button>
              <div id="pdf-menu" class="pdf-menu hidden" role="menu" aria-label="Opciones de PDF">
                  <button type="button" class="pdf-menu-item" data-pdf="todo">üìÑ Todo el documento</button>
                  <button type="button" class="pdf-menu-item" data-pdf="persona">üë§ PAAP para la persona usuaria</button>
              </div>
          </div>
          <button id="btn-excel" class="btn-export verde">üìä Descargar Excel</button>
      </div>
</section>

</div> <!-- FIN .app-root -->

<!-- ==========================================================
       SCRIPTS: PAAP_DATA + L√ìGICA DE LA APLICACI√ìN
============================================================ -->
<script src="paap_data.js"></script>
<script>
  // ---------------- CONFIGURACI√ìN GENERAL ----------------

  const MESES_ES = [
    "enero","febrero","marzo","abril","mayo","junio",
    "julio","agosto","septiembre","octubre","noviembre","diciembre"
  ];

  const AREA_CONFIG = {
    "√ÅREA DE CUIDADO PERSONAL, CONTROL Y PROTECCI√ìN": {
      color: "#3b82f6",
      emoji: "üßºüß¥üõü"
    },
    "√ÅREA DE ATENCI√ìN REHABILITADORA, PSICOL√ìGICA Y SOCIAL": {
      color: "#16a34a",
      emoji: "üß†üß©‚ù§Ô∏è"
    }
  };

  const ORDEN_AREAS = [
    "√ÅREA DE CUIDADO PERSONAL, CONTROL Y PROTECCI√ìN",
    "√ÅREA DE ATENCI√ìN REHABILITADORA, PSICOL√ìGICA Y SOCIAL"
  ];

  const SMART_GUIA_TEXTO = `
  Un objetivo SMART es aquel que est√° formulado de forma:
  <strong>Espec√≠fica</strong> (describe con claridad qu√© se quiere lograr),
  <strong>Medible</strong> (permite comprobar si se ha conseguido),
  <strong>Alcanzable</strong> (realista para la persona y su contexto),
  <strong>Relevante</strong> (con sentido para la persona y su proyecto de vida) y
  <strong>Temporalizada</strong> (incluye un plazo aproximado).

  Algunas claves:
  <ul>
    <li>Describir la conducta observable que realizar√° la persona.</li>
    <li>Indicar el contexto donde se llevar√° a cabo (sala, ba√±o, comedor, piscina, comunidad,‚Ä¶).</li>
    <li>Incluir apoyos necesarios (pautas, adaptaciones, ayudas t√©cnicas,‚Ä¶).</li>
    <li>Definir una frecuencia o criterio de √©xito (veces, porcentaje, nivel de ayuda,‚Ä¶).</li>
    <li>A√±adir un plazo orientativo al final del objetivo (por ejemplo ‚Äúen 6 meses‚Äù).</li>
  </ul>
  <strong>Ejemplos de formulaci√≥n SMART (Centro de D√≠a):</strong>
  <ol>
    <li>√Årea de cuidado personal: ‚ÄúLa persona participar√° en el aseo de manos y cara cada ma√±ana, realizando al menos 3 de los pasos de forma aut√≥noma con apoyo verbal, 4 d√≠as por semana, en 6 meses‚Äù.</li>
    <li>Movilidad y fisioterapia: ‚ÄúLa persona se levantar√° de la silla y se sentar√° de nuevo con apoyo de un profesional, realizando 5 repeticiones seguidas, 3 d√≠as a la semana, en 4 meses, sin manifestar dolor‚Äù.</li>
    <li>Estimulaci√≥n sensorial: ‚ÄúLa persona explorar√° al menos 3 tipos diferentes de est√≠mulos (visual, t√°ctil y auditivo) en la sala multisensorial, mostrando se√±ales de inter√©s o bienestar en el 80% de las sesiones, en 3 meses‚Äù.</li>
    <li>Comunicaci√≥n / Logopedia: ‚ÄúLa persona se√±alar√° o expresar√° con palabras su opci√≥n preferida entre dos alternativas de actividad (A/B) al inicio de la sesi√≥n, en presencia de la profesional de referencia, en 4 de cada 5 d√≠as, en 4 meses‚Äù.</li>
    <li>Salud y alimentaci√≥n: ‚ÄúLa persona tomar√° la comida con textura adaptada manteniendo una postura segura, con pausas entre bocados y supervisi√≥n cercana, reduciendo a cero los episodios de atragantamiento durante 3 meses consecutivos, en 6 meses‚Äù.</li>
  </ol>
  `;
  const estadoPAAP = {
    persona: {
      nombre: "",
      apellidos: "",
      fechaNacimiento: "",
      edad: "",
      aniosCofoil: "",
      taller: "",
      perfiles: [],
      fotoDataUrl: ""
    },
    elaboracion: {
      fecha: "",
      hora: "",
      vigenciaMeses: "",
      proximaRevision: "",
      apoyos: []
    },
    seleccion: {},      // se rellenar√° por √°reas / programas / objetivos
    revision: {}        // seguimiento de revisi√≥n de objetivos espec√≠ficos
  };

  document.addEventListener("DOMContentLoaded", () => {
    if (!window.PAAP_DATA) {
      alert("No se han podido cargar los datos del PAAP (paap_data.js).");
      return;
    }

    inicializarAniosCofoil();
    inicializarDatosPersona();
    inicializarFotoYCamara();
    inicializarPerfilesOcupacionales();
    inicializarDatosElaboracion();
    inicializarAreasTabs();
    inicializarFirmas();
    inicializarExportaciones();

    // Pintar resumen vac√≠o de inicio
    renderResumenGlobal();
  });

/* -----------------------------------------------------------
     INICIALIZACI√ìN DE CAMPOS Y LISTAS AUTOM√ÅTICAS
----------------------------------------------------------- */

function inicializarAniosCofoil() {
  const sel = document.getElementById("anios_cofoil");
  for (let i = 0; i <= 60; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = i + " a√±os";
    sel.appendChild(opt);
  }
}

function inicializarDatosPersona() {
  const nombreInput = document.getElementById("nombre");
  const apellidosInput = document.getElementById("apellidos");
  const fechaNInput = document.getElementById("fecha_nacimiento");
  const edadInput = document.getElementById("edad");
  const aniosSelect = document.getElementById("anios_cofoil");
  const tallerSelect = document.getElementById("taller");

  nombreInput.addEventListener("input", () => {
    estadoPAAP.persona.nombre = nombreInput.value.trim();
    renderResumenGlobal();
  });

  apellidosInput.addEventListener("input", () => {
    estadoPAAP.persona.apellidos = apellidosInput.value.trim();
    renderResumenGlobal();
  });

  fechaNInput.addEventListener("input", () => {
    estadoPAAP.persona.fechaNacimiento = fechaNInput.value;
    edadInput.value = calcularEdad(fechaNInput.value);
    estadoPAAP.persona.edad = edadInput.value;
    renderResumenGlobal();
  });

  aniosSelect.addEventListener("change", () => {
    estadoPAAP.persona.aniosCofoil = aniosSelect.value;
    renderResumenGlobal();
  });

  tallerSelect.addEventListener("change", () => {
    estadoPAAP.persona.taller = tallerSelect.value;
    renderResumenGlobal();
  });
}

function calcularEdad(fechaNacimiento) {
  if (!fechaNacimiento) return "";
  const hoy = new Date();
  const fn = new Date(fechaNacimiento);
  let edad = hoy.getFullYear() - fn.getFullYear();
  const m = hoy.getMonth() - fn.getMonth();
  if (m < 0 || (m === 0 && hoy.getDate() < fn.getDate())) {
    edad--;
  }
  return edad + " a√±os";
}

/* -----------------------------------------------------------
     FOTO Y C√ÅMARA
----------------------------------------------------------- */

function inicializarFotoYCamara() {
  const fileInput = document.getElementById("foto-file");
  const fotoPrev = document.getElementById("foto-preview");
  const abrirCamaraBtn = document.getElementById("abrir-camara");

  const modal = document.getElementById("modal-camara");
  const video = document.getElementById("camara-video");
  const canvas = document.getElementById("camara-canvas");
  const tomarBtn = document.getElementById("tomar-foto");
  const cerrarBtn = document.getElementById("cerrar-camara");

  fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      fotoPrev.src = ev.target.result;
      estadoPAAP.persona.fotoDataUrl = ev.target.result;
      renderResumenGlobal();
    };
    reader.readAsDataURL(file);
  });

  abrirCamaraBtn.addEventListener("click", () => {
    modal.classList.remove("hidden");
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
      })
      .catch(() => {
        alert("No se pudo acceder a la c√°mara.");
        modal.classList.add("hidden");
      });
  });

  cerrarBtn.addEventListener("click", () => {
    cerrarCamara(video, modal);
  });

  tomarBtn.addEventListener("click", () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);
    const dataUrl = canvas.toDataURL("image/png");
    fotoPrev.src = dataUrl;
    estadoPAAP.persona.fotoDataUrl = dataUrl;
    renderResumenGlobal();
    cerrarCamara(video, modal);
  });
}

function cerrarCamara(video, modal) {
  if (video.srcObject) {
    video.srcObject.getTracks().forEach(t => t.stop());
  }
  modal.classList.add("hidden");
}

/* -----------------------------------------------------------
     PERFILES OCUPACIONALES
----------------------------------------------------------- */

function inicializarPerfilesOcupacionales() {
  const sel = document.getElementById("perfil_ocupacional_si_no");
  const bloque = document.getElementById("bloque-perfiles");
  const selector = document.getElementById("perfil_ocupacional_selector");
  const nuevoPerfilInput = document.getElementById("nuevo_perfil");
  const btnAddPerfil = document.querySelector(".btn-add-perfil");

  sel.addEventListener("change", () => {
    if (sel.value === "SI") {
      bloque.classList.remove("hidden");
    } else {
      bloque.classList.add("hidden");
      estadoPAAP.persona.perfiles = [];
      renderResumenGlobal();
    }
  });

  selector.addEventListener("change", () => {
    if (selector.value) {
      estadoPAAP.persona.perfiles.push(selector.value);
      renderResumenGlobal();
    }
  });

  btnAddPerfil.addEventListener("click", () => {
    const nuevo = nuevoPerfilInput.value.trim();
    if (!nuevo) return;
    estadoPAAP.persona.perfiles.push(nuevo);
    nuevoPerfilInput.value = "";
    renderResumenGlobal();
  });
}
/* -----------------------------------------------------------
            DATOS DE ELABORACI√ìN DEL PAAP
----------------------------------------------------------- */

function inicializarDatosElaboracion() {
  const fecha = document.getElementById("paap_fecha");
  const hora = document.getElementById("paap_hora");
  const vigencia = document.getElementById("paap_vigencia");
  const proxima = document.getElementById("paap_proxima_revision");
  const apoyosContainer = document.getElementById("apoyos-container");
  const addApoyoBtn = document.getElementById("add-apoyo");

  addApoyoFila();

  fecha.addEventListener("input", () => {
    estadoPAAP.elaboracion.fecha = fecha.value;
    actualizarProximaRevision();
    renderResumenGlobal();
  });

  hora.addEventListener("input", () => {
    estadoPAAP.elaboracion.hora = hora.value;
    renderResumenGlobal();
  });

  vigencia.addEventListener("change", () => {
    estadoPAAP.elaboracion.vigenciaMeses = vigencia.value;
    actualizarProximaRevision();
    renderResumenGlobal();
  });

  addApoyoBtn.addEventListener("click", addApoyoFila);

  function addApoyoFila() {
    const div = document.createElement("div");
    div.className = "fila-apoyo";

    const input = document.createElement("input");
    input.placeholder = "Nombre del profesional";
    input.addEventListener("input", actualizarListaApoyos);

    const btn = document.createElement("button");
    btn.textContent = "‚úï";
    btn.className = "btn ghost tiny";
    btn.addEventListener("click", () => {
      div.remove();
      actualizarListaApoyos();
    });

    div.appendChild(input);
    div.appendChild(btn);
    apoyosContainer.appendChild(div);
  }

  function actualizarListaApoyos() {
    const nombres = [...apoyosContainer.querySelectorAll("input")]
      .map(i => i.value.trim())
      .filter(v => v.length > 0);
    estadoPAAP.elaboracion.apoyos = nombres;
    renderResumenGlobal();
  }

  function actualizarProximaRevision() {
    const f = fecha.value;
    const m = parseInt(vigencia.value);
    if (!f || !m) {
      proxima.value = "";
      estadoPAAP.elaboracion.proximaRevision = "";
      return;
    }
    const fechaObj = new Date(f);
    fechaObj.setMonth(fechaObj.getMonth() + m);
    const mes = MESES_ES[fechaObj.getMonth()];
    const anio = fechaObj.getFullYear();
    proxima.value = mes + " " + anio;
    estadoPAAP.elaboracion.proximaRevision = proxima.value;
  }
}

/* -----------------------------------------------------------
            INICIALIZAR TABS DE √ÅREAS
----------------------------------------------------------- */

function inicializarAreasTabs() {
  const tabs = document.getElementById("areas-tabs");
  const content = document.getElementById("area-content");

  tabs.innerHTML = "";
  content.innerHTML = "";

  // Ordenar las √°reas seg√∫n ORDEN_AREAS
  const areasOrdenadas = [...window.PAAP_DATA].sort((a, b) => {
    const ia = ORDEN_AREAS.indexOf(a.nombre);
    const ib = ORDEN_AREAS.indexOf(b.nombre);
    return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
  });

  areasOrdenadas.forEach((area, idx) => {
    const btn = document.createElement("button");
    btn.className = "tab-btn" + (idx === 0 ? " active" : "");
    btn.style.setProperty("--area-color", AREA_CONFIG[area.nombre]?.color || "#333");
    btn.innerHTML = `${AREA_CONFIG[area.nombre]?.emoji || ""} ${area.nombre}`;
    btn.dataset.area = area.id;

    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      renderArea(area);
    });

    tabs.appendChild(btn);
  });

  // Mostrar la primera √°rea en el orden definido
  if (areasOrdenadas.length > 0) {
    renderArea(areasOrdenadas[0]);
  }
}

/* -----------------------------------------------------------
       RENDERIZADO DE UN √ÅREA COMPLETA
----------------------------------------------------------- */

function renderArea(area) {
  const content = document.getElementById("area-content");
  content.innerHTML = "";

  const color = AREA_CONFIG[area.nombre]?.color || "#555";

  const panel = document.createElement("div");
  panel.className = "area-panel";
  panel.style.setProperty("--area-color", color);

  panel.innerHTML = `
    <div class="area-header">
      <h3>${AREA_CONFIG[area.nombre].emoji} ${area.nombre}</h3>
      <p>Selecciona un programa, objetivo general, objetivo espec√≠fico y personaliza si es necesario.</p>
    </div>

    <div class="area-selects" id="selects-grid-${area.id}">
      <div class="field-group" id="grp-prog-${area.id}">
        <label>Programa</label>
        <select id="sel-prog-${area.id}">
          <option value="">Selecciona...</option>
        </select>
      </div>

      <!-- Solo para √Årea 2 (programas con programaciones) -->
      <div class="field-group hidden" id="grp-progcn-${area.id}" style="grid-column: 2 / 4;">
        <label>Programaci√≥n</label>
        <select id="sel-progcn-${area.id}">
          <option value="">Selecciona...</option>
        </select>
      </div>

      <div class="field-group" id="grp-og-${area.id}">
        <label>Objetivo general</label>
        <select id="sel-og-${area.id}">
          <option value="">Selecciona...</option>
        </select>
      </div>

      <div class="field-group" id="grp-oe-${area.id}">
        <label>Objetivo espec√≠fico</label>
        <select id="sel-oe-${area.id}">
          <option value="">Selecciona...</option>
        </select>
      </div>
    </div>

    <div id="tareas-panel-${area.id}" class="tareas-panel-area"></div>
  `;

  content.appendChild(panel);

  cargarProgramas(area);
}

/* -----------------------------------------------------------
      CARGA DE PROGRAMAS / PROGRAMACIONES / OG / OE PARA UN √ÅREA
----------------------------------------------------------- */

function resetSelect(selectEl) {
  if (!selectEl) return;
  selectEl.innerHTML = '<option value="">Selecciona...</option>';
  selectEl.value = "";
}

function formatearEtiqueta(codigo, texto) {
  const c = (codigo || "").toString().trim();
  if (!c) return texto || "";
  return `${c} - ${texto || ""}`;
}

/* Devuelve el contenedor del que cuelgan OG/OE/Tareas:
   - √Årea 1: el propio programa
   - √Årea 2: la programaci√≥n seleccionada
*/
function getContenedorObjetivos(programa, programacion) {
  return programacion || programa || null;
}

/* Agrupa TODOS los OEs del contenedor, sin vincularlos a un OG concreto */
function obtenerTodasLasOpcionesOE(contenedor) {
  const lista = [];
  const ogs = (contenedor && contenedor.objetivosGenerales) ? contenedor.objetivosGenerales : [];
  ogs.forEach(og => {
    const oes = og.objetivosEspecificos || [];
    oes.forEach(oe => lista.push({ og, oe }));
  });
  return lista;
}

function cargarOGyOEDesdeContenedor(contenedor, selectOG, selectOE, tareasPanel) {
  resetSelect(selectOG);
  resetSelect(selectOE);
  if (tareasPanel) tareasPanel.innerHTML = "";

  if (!contenedor) return;

  // OG
  (contenedor.objetivosGenerales || []).forEach(og => {
    const opt = document.createElement("option");
    opt.value = og.id;
    opt.textContent = formatearEtiqueta(og.codigo, og.texto);
    selectOG.appendChild(opt);
  });

  // OE (TODOS, no dependientes del OG)
  const opcionesOE = obtenerTodasLasOpcionesOE(contenedor);
  opcionesOE.forEach(({ og, oe }) => {
    const opt = document.createElement("option");
    opt.value = `${og.id}|||${oe.id}`;
    opt.textContent = formatearEtiqueta(oe.codigo, oe.texto);
    selectOE.appendChild(opt);
  });
}

function cargarProgramas(area) {
  const selectProg = document.getElementById(`sel-prog-${area.id}`);
  const selectProgcn = document.getElementById(`sel-progcn-${area.id}`);
  const selectOG = document.getElementById(`sel-og-${area.id}`);
  const selectOE = document.getElementById(`sel-oe-${area.id}`);
  const tareasPanel = document.getElementById(`tareas-panel-${area.id}`);

  const grpProgcn = document.getElementById(`grp-progcn-${area.id}`);
  const grpOE = document.getElementById(`grp-oe-${area.id}`);

  resetSelect(selectProg);
  resetSelect(selectProgcn);
  resetSelect(selectOG);
  resetSelect(selectOE);
  tareasPanel.innerHTML = "";

  // Programas
  (area.programas || []).forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = p.nombre;
    selectProg.appendChild(opt);
  });

  function onResetInferiores() {
    resetSelect(selectProgcn);
    resetSelect(selectOG);
    resetSelect(selectOE);
    tareasPanel.innerHTML = "";
    selectOG.disabled = true;
    selectOE.disabled = true;
  }

  function onHabilitarObjetivos() {
    selectOG.disabled = false;
    selectOE.disabled = false;
  }

  selectProg.addEventListener("change", () => {
    const programa = (area.programas || []).find(p => p.id === selectProg.value);

    // Reset de todo lo inferior
    onResetInferiores();

    if (!programa) {
      grpProgcn.classList.add("hidden");
      grpOE.style.gridColumn = "";
      return;
    }

    const tieneProgramaciones = Array.isArray(programa.programaciones) && programa.programaciones.length > 0;

    if (tieneProgramaciones) {
      // Mostrar selector de Programaci√≥n
      grpProgcn.classList.remove("hidden");
      grpOE.style.gridColumn = "2 / 4"; // para equilibrar la segunda fila

      // Cargar programaciones
      (programa.programaciones || []).forEach(pr => {
        const opt = document.createElement("option");
        opt.value = pr.id;
        opt.textContent = pr.nombre;
        selectProgcn.appendChild(opt);
      });

      // Esperar a la selecci√≥n de Programaci√≥n para cargar OG/OE
      selectProgcn.disabled = false;
      return;
    }

    // √Årea 1 (sin programaciones): cargar OG/OE directamente del programa
    grpProgcn.classList.add("hidden");
    grpOE.style.gridColumn = "";
    onHabilitarObjetivos();

    const contenedor = getContenedorObjetivos(programa, null);
    cargarOGyOEDesdeContenedor(contenedor, selectOG, selectOE, tareasPanel);
  });

  selectProgcn.addEventListener("change", () => {
    const programa = (area.programas || []).find(p => p.id === selectProg.value);
    if (!programa) return;

    const progcn = (programa.programaciones || []).find(pr => pr.id === selectProgcn.value);

    resetSelect(selectOG);
    resetSelect(selectOE);
    tareasPanel.innerHTML = "";

    if (!progcn) {
      selectOG.disabled = true;
      selectOE.disabled = true;
      return;
    }

    selectOG.disabled = false;
    selectOE.disabled = false;

    const contenedor = getContenedorObjetivos(programa, progcn);
    cargarOGyOEDesdeContenedor(contenedor, selectOG, selectOE, tareasPanel);
  });

  // OG: no filtra OEs (por dise√±o). Si cambias OG, obligamos a re-seleccionar OE.
  selectOG.addEventListener("change", () => {
    tareasPanel.innerHTML = "";
    selectOE.value = "";
  });

  // OE: al seleccionar uno, ajustamos OG autom√°ticamente y renderizamos tareas
  selectOE.addEventListener("change", () => {
    tareasPanel.innerHTML = "";

    const programa = (area.programas || []).find(p => p.id === selectProg.value);
    if (!programa) return;

    const tieneProgramaciones = Array.isArray(programa.programaciones) && programa.programaciones.length > 0;
    const progcn = tieneProgramaciones
      ? (programa.programaciones || []).find(pr => pr.id === selectProgcn.value)
      : null;

    const contenedor = getContenedorObjetivos(programa, progcn);
    if (!contenedor) return;

    if (!selectOE.value) return;

    const [ogId, oeId] = selectOE.value.split("|||");
    const og = (contenedor.objetivosGenerales || []).find(o => o.id === ogId);
    const oe = og ? (og.objetivosEspecificos || []).find(e => e.id === oeId) : null;

    if (!og || !oe) return;

    // Sincronizar OG con el OE elegido
    selectOG.value = og.id;

    renderTareas(area, programa, progcn, og, oe, tareasPanel);
  });
}

/* -----------------------------------------------------------
      ESTRUCTURA EN ESTADO
----------------------------------------------------------- */

function ensureArea(areaId) {
  if (!estadoPAAP.seleccion[areaId]) {
    estadoPAAP.seleccion[areaId] = { programas: {} };
  }
  return estadoPAAP.seleccion[areaId];
}

function ensurePrograma(areaId, progId) {
  const area = ensureArea(areaId);
  if (!area.programas[progId]) {
    area.programas[progId] = {
      objetivosGenerales: {},   // √Årea 1 (directo) o programas sin programaciones
      programaciones: {}       // √Årea 2 (por programaci√≥n)
    };
  }
  return area.programas[progId];
}

function ensureProgramacion(areaId, progId, progcnId) {
  const prog = ensurePrograma(areaId, progId);
  if (!prog.programaciones[progcnId]) {
    prog.programaciones[progcnId] = { objetivosGenerales: {} };
  }
  return prog.programaciones[progcnId];
}

function ensureOG(areaId, progId, progcnId, ogId) {
  const cont = progcnId ? ensureProgramacion(areaId, progId, progcnId) : ensurePrograma(areaId, progId);

  if (!cont.objetivosGenerales[ogId]) {
    cont.objetivosGenerales[ogId] = { objetivosEspecificos: {} };
  }
  return cont.objetivosGenerales[ogId];
}

function ensureOE(areaId, progId, progcnId, ogId, oeId) {
  const og = ensureOG(areaId, progId, progcnId, ogId);
  if (!og.objetivosEspecificos[oeId]) {
    og.objetivosEspecificos[oeId] = {
      personalizado: "",
      tareas: []
    };
  }
  return og.objetivosEspecificos[oeId];
}

/* -----------------------------------------------------------
      RENDER COMPLETO PANEL TAREAS + SMART
----------------------------------------------------------- */

function makeSafeKey(v) {
  return (v || "")
    .toString()
    .normalize("NFKD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-zA-Z0-9_-]/g, "_");
}

function renderTareas(area, programa, programacion, og, oe, panel) {
  panel.innerHTML = "";
  if (!oe || !og || !programa) return;

  const areaId = area.id;
  const progId = programa.id;
  const progcnId = programacion ? programacion.id : null;

  const ogId = og.id;
  const oeId = oe.id;

  const oeSel = ensureOE(areaId, progId, progcnId, ogId, oeId);

  const key = makeSafeKey([areaId, progId, progcnId || "DIRECTO", ogId, oeId].join("|"));

  // ---- Bloque objetivo espec√≠fico ----
  const box = document.createElement("div");
  box.className = "og-box-grande";

  const tituloOE = oe.codigo ? `${oe.codigo} ¬∑ ${oe.texto}` : oe.texto;

  box.innerHTML = `
    <h3 class="og-box-titulo">${tituloOE}</h3>

    <label class="lbl-smart">¬øReformular objetivo espec√≠fico?</label>
    <div>
      <label>
        <input type="radio" name="smart-${key}" value="no">
        No
      </label>
      <label style="margin-left: 15px;">
        <input type="radio" name="smart-${key}" value="si">
        S√≠
      </label>
    </div>

    <label class="lbl-smart" style="margin-top:6px;">Reformular objetivo espec√≠fico (formato SMART)</label>

    <textarea id="txt-oe-${key}"
              class="textarea-objetivo hidden"
              placeholder="Escribe aqu√≠ la versi√≥n personalizada del objetivo SMART..."></textarea>

    <button class="btn-guia-smart" id="btn-guia-${key}">
        üìò Gu√≠a Objetivos SMART
    </button>

    <div class="guia-smart hidden" id="guia-smart-${key}">
        ${SMART_GUIA_TEXTO}
    </div>

    <div class="botones-objetivo">
        <button class="btn primary" id="btn-add-oe-${key}">
            ‚ûï A√±adir objetivo al PAAP
        </button>
        <button class="btn ghost" id="btn-del-oe-${key}">
            üóëÔ∏è Quitar objetivo
        </button>
    </div>
  `;

  panel.appendChild(box);

  const txtOE = document.getElementById(`txt-oe-${key}`);
  const btnGuia = document.getElementById(`btn-guia-${key}`);
  const guiaSmart = document.getElementById(`guia-smart-${key}`);
  const btnAddOE = document.getElementById(`btn-add-oe-${key}`);
  const btnDelOE = document.getElementById(`btn-del-oe-${key}`);

  const radiosSmart = box.querySelectorAll(`input[name="smart-${key}"]`);
  const radioNo = Array.from(radiosSmart).find(r => r.value === "no");
  const radioSi = Array.from(radiosSmart).find(r => r.value === "si");

  if (oeSel.personalizado) {
    txtOE.value = oeSel.personalizado;
    radioSi.checked = true;
    txtOE.classList.remove("hidden");
  } else {
    txtOE.value = "";
    radioNo.checked = true;
    txtOE.classList.add("hidden");
  }

  radiosSmart.forEach(r => {
    r.addEventListener("change", () => {
      if (r.value === "si") {
        txtOE.classList.remove("hidden");
      } else {
        txtOE.classList.add("hidden");
      }
    });
  });

  txtOE.addEventListener("input", () => {
    if (radioSi.checked) {
      oeSel.personalizado = txtOE.value;
    } else {
      oeSel.personalizado = "";
    }
    renderResumenGlobal();
  });

  btnGuia.addEventListener("click", () => {
    guiaSmart.classList.toggle("hidden");
  });

  btnAddOE.addEventListener("click", () => {
    if (radioSi.checked && !txtOE.value.trim()) {
      alert("Introduce una reformulaci√≥n SMART o marca 'No' si no quieres reformular.");
      return;
    }
    if (radioSi.checked) {
      oeSel.personalizado = txtOE.value.trim();
    } else {
      oeSel.personalizado = "";
    }
    alert("Objetivo a√±adido al PAAP.");
    renderResumenGlobal();
  });

  btnDelOE.addEventListener("click", () => {
    const ogSel = ensureOG(areaId, progId, progcnId, ogId);
    delete ogSel.objetivosEspecificos[oeId];
    panel.innerHTML = "";
    renderResumenGlobal();
  });

  // ---- Listado de tareas ----
  const tareasTitulo = document.createElement("h3");
  tareasTitulo.className = "titulo-tareas";
  tareasTitulo.textContent = "Tareas / actividades asociadas";
  panel.appendChild(tareasTitulo);

  (oe.tareas || []).forEach((tareaOriginal, index) => {
    const tareaRow = document.createElement("div");
    tareaRow.className = "tarea-row-completa";

    const chk = document.createElement("input");
    chk.type = "checkbox";

    const existe = (oeSel.tareas || []).find(t => t.codigo === index);
    chk.checked = !!existe;

    const label = document.createElement("div");
    label.className = "tarea-original-texto";
    label.textContent = tareaOriginal;

    const colReform = document.createElement("div");

    const pregunta = document.createElement("label");
    pregunta.textContent = "¬øReformular tarea?";
    pregunta.style.display = "block";
    pregunta.style.fontSize = "13px";

    const radiosWrapper = document.createElement("div");

    const radioNoT = document.createElement("input");
    radioNoT.type = "radio";
    radioNoT.name = `tarea-reform-${key}-${index}`;
    radioNoT.value = "no";

    const lblNoT = document.createElement("label");
    lblNoT.appendChild(radioNoT);
    lblNoT.appendChild(document.createTextNode(" No"));

    const radioSiT = document.createElement("input");
    radioSiT.type = "radio";
    radioSiT.name = `tarea-reform-${key}-${index}`;
    radioSiT.value = "si";

    const lblSiT = document.createElement("label");
    lblSiT.style.marginLeft = "10px";
    lblSiT.appendChild(radioSiT);
    lblSiT.appendChild(document.createTextNode(" S√≠"));

    radiosWrapper.appendChild(lblNoT);
    radiosWrapper.appendChild(lblSiT);

    const txtCustom = document.createElement("textarea");
    txtCustom.className = "tarea-custom-textarea hidden";
    txtCustom.placeholder = "Opcional: reformular esta tarea‚Ä¶";

    if (existe && existe.reformulada) {
      radioSiT.checked = true;
      txtCustom.classList.remove("hidden");
      txtCustom.value = existe.reformulada;
    } else {
      radioNoT.checked = true;
      txtCustom.classList.add("hidden");
      txtCustom.value = existe ? (existe.reformulada || "") : "";
    }

    colReform.appendChild(pregunta);
    colReform.appendChild(radiosWrapper);
    colReform.appendChild(txtCustom);

    const btnDel = document.createElement("button");
    btnDel.className = "btn ghost tiny";
    btnDel.textContent = "Eliminar";

    function actualizarTarea() {
      const activo = chk.checked;
      const reformular = radioSiT.checked;
      const textoReform = txtCustom.value;
      toggleTarea(
        areaId,
        progId,
        progcnId,
        ogId,
        oeId,
        index,
        tareaOriginal,
        activo,
        reformular,
        textoReform
      );
    }

    chk.addEventListener("change", actualizarTarea);

    radioNoT.addEventListener("change", () => {
      if (radioNoT.checked) {
        txtCustom.classList.add("hidden");
      }
      if (chk.checked) actualizarTarea();
    });

    radioSiT.addEventListener("change", () => {
      if (radioSiT.checked) {
        txtCustom.classList.remove("hidden");
      }
      if (chk.checked) actualizarTarea();
    });

    txtCustom.addEventListener("input", () => {
      if (chk.checked && radioSiT.checked) {
        actualizarTarea();
      }
    });

    btnDel.addEventListener("click", () => {
      chk.checked = false;
      actualizarTarea();
    });

    tareaRow.appendChild(chk);
    tareaRow.appendChild(label);
    tareaRow.appendChild(colReform);
    tareaRow.appendChild(btnDel);

    panel.appendChild(tareaRow);
  });
}

/* -----------------------------------------------------------
      A√ëADIR / QUITAR TAREAS
----------------------------------------------------------- */

function toggleTarea(areaId, progId, progcnId, ogId, oeId, index, original, activo, reformular, reformuladaTexto) {
  const oeSel = ensureOE(areaId, progId, progcnId, ogId, oeId);
  const pos = (oeSel.tareas || []).findIndex(t => t.codigo === index);

  if (activo) {
    const reform = reformular ? (reformuladaTexto || "") : "";
    if (pos === -1) {
      oeSel.tareas.push({
        codigo: index,
        original: original,
        reformulada: reform
      });
    } else {
      oeSel.tareas[pos].original = original;
      oeSel.tareas[pos].reformulada = reform;
    }
  } else {
    if (pos !== -1) {
      oeSel.tareas.splice(pos, 1);
    }
  }

  renderResumenGlobal();
}

/* -----------------------------------------------------------
      RENDERIZADO DEL RESUMEN GLOBAL
----------------------------------------------------------- */

function renderResumenGlobal() {
  renderTituloResumen();
  renderResumenPersona();
  renderResumenElaboracion();
  renderResumenAreas();
}

/* ---------- T√≠tulo ---------- */

function renderTituloResumen() {
  const titulo = document.getElementById("titulo-resumen");
  const p = estadoPAAP.persona;
  const e = estadoPAAP.elaboracion;

  const nombreCompleto = [p.nombre, p.apellidos].filter(Boolean).join(" ");
  const textoNombre = nombreCompleto || "PERSONA USUARIA";

  let desde = "[mes/a√±o]";
  if (e.fecha) {
    const f = new Date(e.fecha);
    const mes = MESES_ES[f.getMonth()];
    const anio = f.getFullYear();
    desde = `${mes} ${anio}`;
  }

  let hasta = e.proximaRevision || "[mes/a√±o]";

  titulo.textContent = `PAAP PARA ${textoNombre} ‚Äì desde ${desde} hasta ${hasta}`;
}

/* ---------- Resumen persona ---------- */

function renderResumenPersona() {
  const div = document.getElementById("resumen-persona-texto");
  const p = estadoPAAP.persona;
  const foto = document.getElementById("resumen-foto");

  div.innerHTML = "";

  const nombreCompleto = [p.nombre, p.apellidos].filter(Boolean).join(" ") || "No indicado";
  const edad = p.edad || "No indicada";
  const fechaN = p.fechaNacimiento || "No indicada";
  const aniosCofoil = p.aniosCofoil ? p.aniosCofoil + " a√±os" : "No indicado";
  const taller = p.taller || "No indicado";
  const perfiles = (p.perfiles && p.perfiles.length) ? p.perfiles.join(", ") : "No especificado";

  const lineas = [
    `<strong>Nombre y apellidos:</strong> ${nombreCompleto}`,
    `<strong>Fecha de nacimiento:</strong> ${fechaN}`,
    `<strong>Edad:</strong> ${edad}`,
    `<strong>A√±os como persona usuaria del CENTRO DE D√çA APASCOVI:</strong> ${aniosCofoil}`,
    `<strong>Taller ocupacional actual:</strong> ${taller}`,
    `<strong>Perfiles ocupacionales identificados:</strong> ${perfiles}`
  ];

  lineas.forEach(html => {
    const pEl = document.createElement("p");
    pEl.innerHTML = html;
    div.appendChild(pEl);
  });

  if (p.fotoDataUrl) {
    foto.src = p.fotoDataUrl;
  } else {
    foto.removeAttribute("src");
  }
}

/* ---------- Resumen elaboraci√≥n ---------- */

function renderResumenElaboracion() {
  const div = document.getElementById("resumen-elaboracion-texto");
  const e = estadoPAAP.elaboracion;

  div.innerHTML = "";

  const fecha = e.fecha || "No indicada";
  const hora = e.hora || "No indicada";
  const vig = e.vigenciaMeses ? e.vigenciaMeses + " meses" : "No indicado";
  const prox = e.proximaRevision || "No calculada";
  const apoyos = (e.apoyos && e.apoyos.length) ? e.apoyos.join(", ") : "No indicado";

  const lineas = [
    `<strong>Fecha de elaboraci√≥n:</strong> ${fecha}`,
    `<strong>Hora:</strong> ${hora}`,
    `<strong>Periodo de vigencia del PAAP:</strong> ${vig}`,
    `<strong>Pr√≥xima revisi√≥n:</strong> ${prox}`,
    `<strong>Persona/s de apoyo en la elaboraci√≥n:</strong> ${apoyos}`
  ];

  lineas.forEach(html => {
    const pEl = document.createElement("p");
    pEl.innerHTML = html;
    div.appendChild(pEl);
  });
}

/* ---------- Seguimiento: estructura de revisi√≥n por OE ---------- */

function getRevisionKey(progcnId) {
  return progcnId ? progcnId : "__DIRECTO__";
}

function ensureRevision(areaId, progId, progcnId, ogId, oeId) {
  const k = getRevisionKey(progcnId);

  if (!estadoPAAP.revision[areaId]) estadoPAAP.revision[areaId] = {};
  if (!estadoPAAP.revision[areaId][progId]) estadoPAAP.revision[areaId][progId] = {};
  if (!estadoPAAP.revision[areaId][progId][k]) estadoPAAP.revision[areaId][progId][k] = {};
  if (!estadoPAAP.revision[areaId][progId][k][ogId]) estadoPAAP.revision[areaId][progId][k][ogId] = {};

  if (!estadoPAAP.revision[areaId][progId][k][ogId][oeId]) {
    estadoPAAP.revision[areaId][progId][k][ogId][oeId] = {
      fecha1: "",
      r1: "",
      fecha2: "",
      r2: ""
    };
  }
  return estadoPAAP.revision[areaId][progId][k][ogId][oeId];
}

/* Obtener la fecha de revisi√≥n 1/2 a nivel de PROGRAMA, buscando la primera que encuentre en cualquier OE del programa */
function getFechaPrograma(areaId, progId, campoFecha) {
  const areaRev = estadoPAAP.revision[areaId];
  if (!areaRev) return "";
  const progRev = areaRev[progId];
  if (!progRev) return "";

  const progcnKeys = Object.keys(progRev);
  for (const k of progcnKeys) {
    const ogMap = progRev[k] || {};
    const ogIds = Object.keys(ogMap);
    for (const ogId of ogIds) {
      const oeMap = ogMap[ogId] || {};
      const oeIds = Object.keys(oeMap);
      for (const oeId of oeIds) {
        const rev = oeMap[oeId];
        if (rev && rev[campoFecha]) return rev[campoFecha];
      }
    }
  }
  return "";
}

/* Actualizar fecha 1 o 2 de TODO el programa (se copia a todos los OEs del programa, incluidas programaciones) */
function actualizarFechaPrograma(areaId, progId, campoFecha, valor) {
  const areaSel = estadoPAAP.seleccion[areaId];
  if (!areaSel) return;

  const progSel = (areaSel.programas || {})[progId];
  if (!progSel) return;

  // Directo (√Årea 1)
  const ogSelMapDirecto = progSel.objetivosGenerales || {};
  Object.keys(ogSelMapDirecto).forEach(ogId => {
    const ogSel = ogSelMapDirecto[ogId];
    const oeSelMap = ogSel.objetivosEspecificos || {};
    Object.keys(oeSelMap).forEach(oeId => {
      const rev = ensureRevision(areaId, progId, null, ogId, oeId);
      rev[campoFecha] = valor;
    });
  });

  // Por programaciones (√Årea 2)
  const progcnSelMap = progSel.programaciones || {};
  Object.keys(progcnSelMap).forEach(progcnId => {
    const progcnSel = progcnSelMap[progcnId];
    const ogSelMap = progcnSel.objetivosGenerales || {};
    Object.keys(ogSelMap).forEach(ogId => {
      const ogSel = ogSelMap[ogId];
      const oeSelMap = ogSel.objetivosEspecificos || {};
      Object.keys(oeSelMap).forEach(oeId => {
        const rev = ensureRevision(areaId, progId, progcnId, ogId, oeId);
        rev[campoFecha] = valor;
      });
    });
  });
}

/* Actualizaci√≥n de revisi√≥n para un objetivo espec√≠fico concreto */
function actualizarRevision(areaId, progId, progcnId, ogId, oeId, campo, valor) {
  const rev = ensureRevision(areaId, progId, progcnId, ogId, oeId);
  rev[campo] = valor;
}

/* ---------- Bloques por √°rea (colores pastel + emojis) + SEGUIMIENTO ---------- */

function renderResumenAreas() {
  const cont = document.getElementById("resumen-areas");
  cont.innerHTML = "";

  const data = window.PAAP_DATA || [];

  data.forEach(areaDef => {
    const areaSel = estadoPAAP.seleccion[areaDef.id];
    if (!areaSel) return;

    const programasSel = areaSel.programas || {};
    const progIds = Object.keys(programasSel);
    if (!progIds.length) return;

    const conf = AREA_CONFIG[areaDef.nombre] || { color: "#555", emoji: "" };

    const tarjeta = document.createElement("div");
    tarjeta.className = "resumen-area-card";
    tarjeta.style.setProperty("--area-color", conf.color);

    const titulo = document.createElement("h3");
    titulo.className = "resumen-area-titulo";
    titulo.innerHTML = `<span class="resumen-area-emoji">${conf.emoji}</span> ${areaDef.nombre}`;
    tarjeta.appendChild(titulo);

    // ==== PROGRAMAS DEL √ÅREA ====
    progIds.forEach(progId => {
      const progSel = programasSel[progId];
      const progDef = (areaDef.programas || []).find(p => p.id === progId);
      if (!progDef) return;

      const bloqueProg = document.createElement("div");
      bloqueProg.className = "resumen-programa";

      // CABECERA PROGRAMA: nombre + fechas revisi√≥n a la derecha
      const cabeceraProg = document.createElement("div");
      cabeceraProg.style.display = "flex";
      cabeceraProg.style.justifyContent = "space-between";
      cabeceraProg.style.alignItems = "center";
      cabeceraProg.style.gap = "16px";

      const h4 = document.createElement("h4");
      h4.textContent = progDef.nombre;

      const fechasWrapper = document.createElement("div");
      fechasWrapper.style.display = "flex";
      fechasWrapper.style.gap = "8px";
      fechasWrapper.style.alignItems = "center";
      fechasWrapper.style.fontSize = "0.85rem";

      const fecha1Valor = getFechaPrograma(areaDef.id, progDef.id, "fecha1");
      const fecha2Valor = getFechaPrograma(areaDef.id, progDef.id, "fecha2");

      const bloqueF1 = document.createElement("div");
      const lblF1 = document.createElement("label");
      lblF1.textContent = "Fecha revisi√≥n 1:";
      lblF1.style.marginRight = "4px";
      const inpF1 = document.createElement("input");
      inpF1.type = "date";
      inpF1.value = fecha1Valor;
      inpF1.onchange = function () {
        actualizarFechaPrograma(areaDef.id, progDef.id, "fecha1", this.value);
      };
      bloqueF1.appendChild(lblF1);
      bloqueF1.appendChild(inpF1);

      const bloqueF2 = document.createElement("div");
      const lblF2 = document.createElement("label");
      lblF2.textContent = "Fecha revisi√≥n 2:";
      lblF2.style.marginRight = "4px";
      const inpF2 = document.createElement("input");
      inpF2.type = "date";
      inpF2.value = fecha2Valor;
      inpF2.onchange = function () {
        actualizarFechaPrograma(areaDef.id, progDef.id, "fecha2", this.value);
      };
      bloqueF2.appendChild(lblF2);
      bloqueF2.appendChild(inpF2);

      fechasWrapper.appendChild(bloqueF1);
      fechasWrapper.appendChild(bloqueF2);

      cabeceraProg.appendChild(h4);
      cabeceraProg.appendChild(fechasWrapper);

      bloqueProg.appendChild(cabeceraProg);

      // ---------- Helper interno: renderiza una secci√≥n (directa o por programaci√≥n) ----------
      function renderSeccionObjetivos(tituloSeccion, contenedorDef, contenedorSel, progcnId) {
        const ogSelMap = (contenedorSel && contenedorSel.objetivosGenerales) ? contenedorSel.objetivosGenerales : {};
        const ogIds = Object.keys(ogSelMap);
        if (!ogIds.length) return;

        if (tituloSeccion) {
          const h5 = document.createElement("h5");
          h5.style.margin = "10px 0 6px";
          h5.style.fontSize = "0.98rem";
          h5.style.opacity = "0.95";
          h5.textContent = tituloSeccion;
          bloqueProg.appendChild(h5);
        }

        ogIds.forEach(ogId => {
          const ogSel = ogSelMap[ogId];
          const ogDef = (contenedorDef.objetivosGenerales || []).find(o => o.id === ogId);
          if (!ogDef) return;

          const bloqueOG = document.createElement("div");
          bloqueOG.className = "resumen-og-bloque";

          const pOG = document.createElement("p");
          pOG.className = "resumen-og-titulo";
          const ogTitulo = ogDef.codigo ? `${ogDef.codigo} ¬∑ ${ogDef.texto}` : ogDef.texto;
          pOG.textContent = ogTitulo;
          bloqueOG.appendChild(pOG);

          const oeSelMap = ogSel.objetivosEspecificos || {};
          const oeIds = Object.keys(oeSelMap);

          oeIds.forEach(oeId => {
            const oeSel = oeSelMap[oeId];
            const oeDef = (ogDef.objetivosEspecificos || []).find(e => e.id === oeId);
            if (!oeDef) return;

            const rev = ensureRevision(areaDef.id, progDef.id, progcnId || null, ogDef.id, oeDef.id);

            const filaOE = document.createElement("div");
            filaOE.style.display = "flex";
            filaOE.style.justifyContent = "space-between";
            filaOE.style.alignItems = "flex-start";
            filaOE.style.gap = "12px";
            filaOE.style.marginTop = "4px";

            // Columna izquierda
            const colTexto = document.createElement("div");
            colTexto.style.flex = "0 0 70%";
            colTexto.style.fontSize = "1rem";

            const pOE = document.createElement("p");
            pOE.className = "resumen-oe-titulo";
            const oeTitulo = oeDef.codigo ? `${oeDef.codigo} ¬∑ ${oeDef.texto}` : oeDef.texto;
            pOE.textContent = oeTitulo;
            colTexto.appendChild(pOE);

            if (oeSel.personalizado) {
              const pPers = document.createElement("p");
              pPers.className = "resumen-oe-personalizado";
              pPers.textContent = `Objetivo personalizado: ${oeSel.personalizado}`;
              colTexto.appendChild(pPers);
            }

            if (oeSel.tareas && oeSel.tareas.length) {
              const ul = document.createElement("ul");
              ul.className = "resumen-tareas-lista";
              oeSel.tareas.forEach(t => {
                const li1 = document.createElement("li");
                li1.textContent = t.original;
                ul.appendChild(li1);

                if (t.reformulada) {
                  const li2 = document.createElement("li");
                  li2.innerHTML = `<strong>Tarea/Actividad reformulada:</strong> ${t.reformulada}`;
                  ul.appendChild(li2);
                }
              });
              colTexto.appendChild(ul);
            }

            // Columna derecha: revisiones
            const colRev = document.createElement("div");
            colRev.style.flex = "0 0 30%";
            colRev.style.fontSize = "0.9rem";
            colRev.style.display = "flex";
            colRev.style.gap = "8px";

            const colR1 = document.createElement("div");
            colR1.style.flex = "1";

            const lblR1 = document.createElement("label");
            lblR1.innerHTML = "<strong>Revisi√≥n 1:</strong>";
            const selR1 = document.createElement("select");
            selR1.style.width = "100%";
            selR1.onchange = function () {
              actualizarRevision(areaDef.id, progDef.id, progcnId || null, ogDef.id, oeDef.id, "r1", this.value);
            };

            const optR1_0 = document.createElement("option");
            optR1_0.value = "";
            optR1_0.textContent = "";
            const optR1_1 = document.createElement("option");
            optR1_1.value = "Alcanzado";
            optR1_1.textContent = "‚úÖ Alcanzado";
            const optR1_2 = document.createElement("option");
            optR1_2.value = "En progreso";
            optR1_2.textContent = "üîÑ En progreso";
            const optR1_3 = document.createElement("option");
            optR1_3.value = "No alcanzado";
            optR1_3.textContent = "‚ùå No alcanzado";

            selR1.appendChild(optR1_0);
            selR1.appendChild(optR1_1);
            selR1.appendChild(optR1_2);
            selR1.appendChild(optR1_3);
            selR1.value = rev.r1 || "";

            colR1.appendChild(lblR1);
            colR1.appendChild(selR1);

            const colR2 = document.createElement("div");
            colR2.style.flex = "1";

            const lblR2 = document.createElement("label");
            lblR2.innerHTML = "<strong>Revisi√≥n 2:</strong>";
            const selR2 = document.createElement("select");
            selR2.style.width = "100%";
            selR2.onchange = function () {
              actualizarRevision(areaDef.id, progDef.id, progcnId || null, ogDef.id, oeDef.id, "r2", this.value);
            };

            const optR2_0 = document.createElement("option");
            optR2_0.value = "";
            optR2_0.textContent = "";
            const optR2_1 = document.createElement("option");
            optR2_1.value = "Alcanzado";
            optR2_1.textContent = "‚úÖ Alcanzado";
            const optR2_2 = document.createElement("option");
            optR2_2.value = "En progreso";
            optR2_2.textContent = "üîÑ En progreso";
            const optR2_3 = document.createElement("option");
            optR2_3.value = "No alcanzado";
            optR2_3.textContent = "‚ùå No alcanzado";

            selR2.appendChild(optR2_0);
            selR2.appendChild(optR2_1);
            selR2.appendChild(optR2_2);
            selR2.appendChild(optR2_3);
            selR2.value = rev.r2 || "";

            colR2.appendChild(lblR2);
            colR2.appendChild(selR2);

            colRev.appendChild(colR1);
            colRev.appendChild(colR2);

            filaOE.appendChild(colTexto);
            filaOE.appendChild(colRev);

            bloqueOG.appendChild(filaOE);
          });

          bloqueProg.appendChild(bloqueOG);
        });
      }

      // 1) Directo (√Årea 1)
      renderSeccionObjetivos(null, progDef, progSel, null);

      // 2) Por programaciones (√Årea 2)
      const progcnSelMap = progSel.programaciones || {};
      const progcnIds = Object.keys(progcnSelMap);
      if (progcnIds.length) {
        progcnIds.forEach(progcnId => {
          const progcnSel = progcnSelMap[progcnId];
          const progcnDef = (progDef.programaciones || []).find(pr => pr.id === progcnId);
          if (!progcnDef) return;
          renderSeccionObjetivos(progcnDef.nombre, progcnDef, progcnSel, progcnId);
        });
      }

      tarjeta.appendChild(bloqueProg);
    });

    cont.appendChild(tarjeta);
  });
}

/* -----------------------------------------------------------
      EXPORTACIONES: PDF (solo informe) y Excel
----------------------------------------------------------- */


function inicializarFirmas() {
  const firmas = [
    { canvasId: "firma-inicial", clearId: "clear-firma-inicial" },
    { canvasId: "firma-rev1", clearId: "clear-firma-rev1" },
    { canvasId: "firma-rev2", clearId: "clear-firma-rev2" }
  ];

  firmas.forEach(f => {
    const canvas = document.getElementById(f.canvasId);
    const clearBtn = document.getElementById(f.clearId);
    if (!canvas || !clearBtn) return;

    // Ajuste de tama√±o al contenedor visible
    canvas.width = canvas.offsetWidth || 260;
    canvas.height = canvas.offsetHeight || 120;

    const ctx = canvas.getContext("2d");
    ctx.lineWidth = 2;
    ctx.lineCap = "round";

    let dibujando = false;
    let ultimaX = 0;
    let ultimaY = 0;

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches && e.touches.length > 0) {
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top
        };
      } else {
        return {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };
      }
    }

    function empezarDibujo(e) {
      e.preventDefault();
      dibujando = true;
      const pos = getPos(e);
      ultimaX = pos.x;
      ultimaY = pos.y;
    }

    function dibujar(e) {
      if (!dibujando) return;
      e.preventDefault();
      const pos = getPos(e);
      ctx.beginPath();
      ctx.moveTo(ultimaX, ultimaY);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      ultimaX = pos.x;
      ultimaY = pos.y;
    }

    function terminarDibujo(e) {
      if (!dibujando) return;
      e.preventDefault();
      dibujando = false;
    }

    canvas.addEventListener("mousedown", empezarDibujo);
    canvas.addEventListener("mousemove", dibujar);
    canvas.addEventListener("mouseup", terminarDibujo);
    canvas.addEventListener("mouseleave", terminarDibujo);

    canvas.addEventListener("touchstart", empezarDibujo, { passive: false });
    canvas.addEventListener("touchmove", dibujar, { passive: false });
    canvas.addEventListener("touchend", terminarDibujo, { passive: false });

    clearBtn.addEventListener("click", () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
  });
}

/* -----------------------------------------------------------
      EXPORTACIONES: PDF y Excel
----------------------------------------------------------- */
function inicializarExportaciones() {
  const btnPDF = document.getElementById("btn-pdf");
  const btnExcel = document.getElementById("btn-excel");

  const pdfMenu = document.getElementById("pdf-menu");
  const pdfItems = document.querySelectorAll(".pdf-menu-item");

  // Desplegable PDF
  if (btnPDF && pdfMenu) {
    btnPDF.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      pdfMenu.classList.toggle("hidden");
    });

    // Cerrar al hacer click fuera
    document.addEventListener("click", () => {
      if (!pdfMenu.classList.contains("hidden")) pdfMenu.classList.add("hidden");
    });

    // Evitar cierre al clicar dentro del men√∫
    pdfMenu.addEventListener("click", (e) => e.stopPropagation());

    pdfItems.forEach((item) => {
      item.addEventListener("click", () => {
        const modo = item.getAttribute("data-pdf") || "persona";
        pdfMenu.classList.add("hidden");
        exportarPDF(modo);
      });
    });
  } else if (btnPDF) {
    // Fallback: si por lo que sea no existe el men√∫
    btnPDF.addEventListener("click", () => exportarPDF("persona"));
  }

  // Excel
  if (btnExcel) btnExcel.addEventListener("click", exportarExcel);
}

/* ---------- PDF: solo secci√≥n resumen ---------- */
/* ---------- Impresi√≥n (Guardar como PDF / Imprimir) ---------- */
function imprimirComoPDF(elemento, titulo = "PAAP") {
  const win = window.open("", "_blank");
  if (!win) {
    alert("El navegador ha bloqueado la ventana emergente necesaria para imprimir. Permite pop-ups y vuelve a intentarlo.");
    return;
  }

  const toAbs = (u) => {
    try { return new URL(u, window.location.href).href; } catch (e) { return u; }
  };

  // Clonamos el contenido y convertimos los canvas (firmas) a im√°genes para que se vean en impresi√≥n/PDF
  const clon = elemento.cloneNode(true);

  const canvasOriginales = elemento.querySelectorAll("canvas");
  const canvasClonados = clon.querySelectorAll("canvas");
  canvasOriginales.forEach((c, i) => {
    const cl = canvasClonados[i];
    if (!cl) return;

    const img = document.createElement("img");
    img.alt = "Firma";
    try {
      img.src = c.toDataURL("image/png");
    } catch (e) {
      return;
    }
    img.style.width = "100%";
    img.style.height = "auto";
    img.style.display = "block";
    cl.replaceWith(img);
  });

  // Convertimos rutas de im√°genes a absolutas (logos, iconos, foto, etc.)
  clon.querySelectorAll("img").forEach(img => {
    const src = img.getAttribute("src");
    if (!src) return;
    if (src.startsWith("data:") || src.startsWith("http") || src.startsWith("blob:")) return;
    img.setAttribute("src", toAbs(src));
  });

  // Ocultar botones/men√∫s de exportaci√≥n en impresi√≥n
  clon.querySelectorAll(".resumen-export-buttons, .export-dropdown, #pdf-menu").forEach(b => b.remove());

  // Cargamos CSS con rutas absolutas para que el nuevo tab lo encuentre
  const cssLinks = Array.from(document.querySelectorAll('link[rel="stylesheet"]'))
    .map(l => {
      const href = l.getAttribute("href");
      if (!href) return "";
      return `<link rel="stylesheet" href="${toAbs(href)}">`;
    })
    .join("\n");

  // Copiamos estilos inline (incluyendo los ‚Äúajustes puntuales‚Äù)
  const inlineStyles = Array.from(document.querySelectorAll("style"))
    .map(s => `<style>${s.innerHTML}</style>`)
    .join("\n");

  win.document.open();
  win.document.write(`<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${titulo}</title>
${cssLinks}
${inlineStyles}
<style>
  body{ background:#fff; padding:20px; }
  .app-root{ max-width:1100px; margin:0 auto; }
  @media print{
    button{ display:none !important; }
  }
</style>
</head>
<body>
${clon.outerHTML}
</body>
</html>`);
  win.document.close();

  win.onload = () => {
    win.focus();
    win.print();
  };
}


function exportarPDF(modo = "persona") {
  const objetivo = (modo === "todo")
    ? document.querySelector(".app-root")
    : document.getElementById("resumen-section");

  if (!objetivo) {
    alert("No se ha encontrado el contenido a exportar a PDF.");
    return;
  }

  const titulo = (modo === "todo")
    ? "PAAP_CENTRO_DIA_APASCOVI_COMPLETO"
    : "PAAP_PARA_PERSONA_USUARIA";

  // Abrimos una vista de impresi√≥n: desde ah√≠ el usuario decide imprimir o guardar como PDF
  imprimirComoPDF(objetivo, titulo);
}

/* ---------- EXCEL: estructura tabular del PAAP ---------- */

function exportarExcel() {
  try {
  const persona = estadoPAAP.persona;
  const elaboracion = estadoPAAP.elaboracion;
  const datos = window.PAAP_DATA || [];

  const filas = [];

  function pushFila(base, tareaTexto) {
    filas.push({
      "Nombre": persona.nombre,
      "Apellidos": persona.apellidos,
      "Fecha nacimiento": persona.fechaNacimiento,
      "Edad": persona.edad,
      "A√±os CENTRO DE D√çA": persona.aniosCofoil,
      "Taller": persona.taller,
      "Perfiles ocupacionales": (persona.perfiles || []).join(", "),
      "√Årea": base.areaNombre,
      "Programa": base.programaNombre,
      "Programaci√≥n": base.programacionNombre || "",
      "Objetivo general": base.ogTexto,
      "Objetivo espec√≠fico": base.oeTexto,
      "Objetivo espec√≠fico personalizado": base.oePersonalizado || "",
      "Tarea/Actividad": tareaTexto || "",
      "Fecha elaboraci√≥n": elaboracion.fecha,
      "Hora elaboraci√≥n": elaboracion.hora,
      "Vigencia (meses)": elaboracion.vigenciaMeses,
      "Pr√≥xima revisi√≥n": elaboracion.proximaRevision,
      "Personas de apoyo": (elaboracion.apoyos || []).join(", ")
    });
  }

  function recorrerSeleccion(areaDef, progDef, contenedorDef, contenedorSel, programacionNombre) {
    const ogSelMap = (contenedorSel && contenedorSel.objetivosGenerales) ? contenedorSel.objetivosGenerales : {};
    const ogIds = Object.keys(ogSelMap);
    if (!ogIds.length) return;

    ogIds.forEach(ogId => {
      const ogSel = ogSelMap[ogId];
      const ogDef = (contenedorDef.objetivosGenerales || []).find(o => o.id === ogId);
      if (!ogDef) return;

      const oeSelMap = ogSel.objetivosEspecificos || {};
      const oeIds = Object.keys(oeSelMap);

      oeIds.forEach(oeId => {
        const oeSel = oeSelMap[oeId];
        const oeDef = (ogDef.objetivosEspecificos || []).find(e => e.id === oeId);
        if (!oeDef) return;

        const base = {
          areaNombre: areaDef.nombre,
          programaNombre: progDef.nombre,
          programacionNombre: programacionNombre || "",
          ogTexto: ogDef.texto,
          oeTexto: oeDef.texto,
          oePersonalizado: oeSel.personalizado || ""
        };

        if (!oeSel.tareas || !oeSel.tareas.length) {
          pushFila(base, "");
        } else {
          oeSel.tareas.forEach(t => {
            pushFila(base, t.reformulada || t.original);
          });
        }
      });
    });
  }

  datos.forEach(areaDef => {
    const areaSel = estadoPAAP.seleccion[areaDef.id];
    if (!areaSel) return;

    const programasSel = areaSel.programas || {};
    Object.keys(programasSel).forEach(progId => {
      const progSel = programasSel[progId];
      const progDef = (areaDef.programas || []).find(p => p.id === progId);
      if (!progDef) return;

      // Directo (√Årea 1)
      recorrerSeleccion(areaDef, progDef, progDef, progSel, "");

      // Por programaciones (√Årea 2)
      const progcnSelMap = progSel.programaciones || {};
      Object.keys(progcnSelMap).forEach(progcnId => {
        const progcnSel = progcnSelMap[progcnId];
        const progcnDef = (progDef.programaciones || []).find(pr => pr.id === progcnId);
        if (!progcnDef) return;

        recorrerSeleccion(areaDef, progDef, progcnDef, progcnSel, progcnDef.nombre);
      });
    });
  });

  if (!filas.length) {
    alert("No hay informaci√≥n seleccionada para exportar.");
    return;
  }
  // Si la librer√≠a XLSX est√° disponible, generamos .xlsx.
  // Si no, exportamos un .xls "compatible" (tabla HTML) que Excel abre sin problema.
  if (typeof XLSX !== "undefined") {
    const hoja = XLSX.utils.json_to_sheet(filas);
    const libro = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(libro, hoja, "PAAP");
    XLSX.writeFile(libro, "PAAP_CENTRO_DIA_APASCOVI.xlsx");
  } else {
    exportarExcelFallbackXLS(filas, "PAAP_CENTRO_DIA_APASCOVI.xls");
  }
} catch (err) {
    console.error("Error al generar Excel:", err);
    alert("Se ha producido un error al generar el Excel.");
  }
}



/* ---------- Excel fallback (sin XLSX): genera un .xls compatible (HTML Table) ---------- */
function exportarExcelFallbackXLS(filas, filename) {
  if (!filas || !filas.length) {
    alert("No hay informaci√≥n seleccionada para exportar.");
    return;
  }

  const columnas = Object.keys(filas[0]);
  const escapeHTML = (v) => String(v ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");

  let html = "<table border='1'><thead><tr>";
  columnas.forEach(c => { html += `<th>${escapeHTML(c)}</th>`; });
  html += "</tr></thead><tbody>";

  filas.forEach(f => {
    html += "<tr>";
    columnas.forEach(c => {
      html += `<td>${escapeHTML(f[c])}</td>`;
    });
    html += "</tr>";
  });

  html += "</tbody></table>";

  const blob = new Blob(
    ["\ufeff" + html],
    { type: "application/vnd.ms-excel;charset=utf-8" }
  );

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename || "PAAP.xls";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(a.href), 1500);
}

</script>
</body>
</html>
